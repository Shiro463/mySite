<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒªï¼ˆã‚¹ãƒãƒ›ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ç‰ˆï¼‰</title>
<style>
  /* ---------------- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ---------------- */
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
    overflow-x: hidden;
  }

  /* ---------------- LocalStorage UI ---------------- */
  .localstorage-block {
    border: 1px solid #aaa;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .localstorage-block .button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .localstorage-block button {
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 5px;
    border: none;
    background: #333;
    color: #fff;
    cursor: pointer;
  }

  /* ---------------- ã‚¯ã‚¤ã‚ºãƒ–ãƒ­ãƒƒã‚¯ ---------------- */
  .quiz-block {
    display: flex;
    flex-direction: column; /* PCã§ã‚‚ç¸¦ä¸¦ã³ã«çµ±ä¸€ */
    border: 1px solid #aaa;
    padding: 10px;
    gap: 20px;
  }

  .quiz-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .title {
    color: #6cb4e4;
    text-align: center;
    padding: 0.5em;
    border-top: 2px solid #6cb4e4;
    border-bottom: 2px solid #6cb4e4;
    background: repeating-linear-gradient(-45deg, #f0f8ff, #f0f8ff 3px, #e9f4ff 3px, #e9f4ff 7px);
    font-size: 22px;
  }

  .question-area, .answer-area {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    font-size: 20px;
    min-height: 120px;
    line-height: 1.5;
    background: #fafafa;
  }

  select {
    font-size: 18px;
    padding: 6px 8px;
  }

  .button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .myButtonBlue, .myButtonGreen, .myButtonRed {
    font-size: 20px;
    padding: 0.5em 1em;
    border-radius: 5px;
    border: 2px solid;
    cursor: pointer;
    transition: 0.3s;
  }

  .myButtonBlue { color: #67c5ff; border-color: #67c5ff; }
  .myButtonBlue:hover { background: #67c5ff; color: white; }
  .myButtonGreen { color: #76ff67; border-color: #76ff67; }
  .myButtonGreen:hover { background: #76ff67; color: white; }
  .myButtonRed { color: #ff6767; border-color: #ff6767; }
  .myButtonRed:hover { background: #ff6767; color: white; }

  /* ---------------- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« ---------------- */
  .status-table {
    display: block;
    overflow-x: auto;
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
  }

  .status-table td {
    padding: 8px;
    border: 1px solid #000;
    text-align: center;
    position: relative;
    min-width: 70px;
  }

  .status-table .wrong-count {
    position: absolute;
    right: 4px;
    top: 2px;
    font-size: 12px;
    color: red;
  }

  .correct-count {
    position: absolute;
    left: 4px;
    top: 2px;
    font-size: 12px;
    color: green;
  }

  .weight-display {
    position: absolute;
    left: 4px;
    bottom: 0;
    font-size: 12px;
    color: gray;
  }

  .blue { background-color: #add8e6; }
  .green { background-color: #90ee90; }
  .red { background-color: #f08080; }

  /* ---------------- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ ---------------- */
  .floating-buttons {
    position: fixed;
    bottom: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 9999;
    background: rgba(255,255,255,0.9);
    padding: 6px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }

  .floating-buttons button {
    padding: 6px 10px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    background: #333;
    color: #fff;
    cursor: pointer;
  }

  .floating-buttons button:hover { background: #555; }

  /* ---------------- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼†ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ ---------------- */
  @media (max-width: 768px) {
    .quiz-block { padding: 8px; gap: 15px; }
    .title { font-size: 20px; padding: 0.4em; }
    .question-area, .answer-area { font-size: 18px; min-height: 100px; padding: 12px; }
    select { font-size: 16px; padding: 4px 6px; }
    .myButtonBlue, .myButtonGreen, .myButtonRed { font-size: 18px; padding: 0.4em 0.8em; }
    .floating-buttons {
      right: 50%;
      transform: translateX(50%);
      flex-direction: row;
      gap: 8px;
    }
    .status-table td { font-size: 12px; min-width: 60px; padding: 6px; }
  }
</style>

<!-- MathJax -->
<script>
window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

<body>

<!-- LocalStorageè¡¨ç¤ºãƒ–ãƒ­ãƒƒã‚¯ -->
<div class="localstorage-block">
  <div class="button-group">
    <button id="showStorageBtn" type="button">LocalStorageè¡¨ç¤º</button>
    <button id="clearStorageBtn" type="button">LocalStorageãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <p id="storageInfo"></p>
</div>

<!-- ã‚¯ã‚¤ã‚ºãƒ–ãƒ­ãƒƒã‚¯ -->
<div class="quiz-block" id="quizBlock-0">
  <div class="quiz-container">
    <p class="title">ã‚¤ã‚¿ãƒªã‚¢èª</p>
    <label>å‡ºé¡Œç¯„å›²:
      <select id="startSelect-0"></select> ã€œ
      <select id="endSelect-0"></select>
    </label>
    <label>ä¸¦ã³é †:
      <select id="sortSelect-0"></select>
    </label>
    <label>é™¤å¤–ã™ã‚‹æ­£è§£æ•°:
      <select id="excludeCorrectSelect-0"></select>
      <button class="myButtonBlue" id="resetCountsBtn-0">ãƒªã‚»ãƒƒãƒˆ</button>
    </label>
    <button class="myButtonBlue" id="nextBtn-0">å‡ºé¡Œ</button>
    <div class="question-area" id="questionArea-0">ã“ã“ã«å•é¡Œæ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <button class="myButtonBlue" id="showAnswerBtn-0">ç­”ãˆã‚’è¦‹ã‚‹</button>
    <div class="answer-area" id="answerArea-0" style="color: gray;">ã“ã“ã«ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div class="button-group">
      <button class="myButtonGreen" id="correctBtn-0">æ­£è§£</button>
      <button class="myButtonRed" id="wrongBtn-0">ä¸æ­£è§£</button>
    </div>
  </div>

  <table class="status-table" id="statusTable-0"></table>
</div>

<!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
<div class="floating-buttons">
  <button data-target="quizBlock-0">ã‚¤ã‚¿ãƒªã‚¢èª</button>
</div>

<script>
const quizData0 = [ /*ã‚¤ã‚¿ãƒªã‚¢èª 40001ï½*/
  { id: 40001, label: "fiore",
  question:
  "fiore (m.)",
  answer:
  "èŠ±" },

  { id: 40002, label: "porta",
  question:
  "porta",
  answer:
  "é–€" },

  { id: 40003, label: "chiave",
  question:
  "chiave (f.)",
  answer:
  "éµ" },

  { id: 40004, label: "tavolo",
  question:
  "tavolo",
  answer:
  "æœº" },

  { id: 40005, label: "cravatta",
  question:
  "cravatta",
  answer:
  "ãƒã‚¯ã‚¿ã‚¤" },



// ===========================================
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//           =======
//      =================
//       ===============
//        =============
//         ===========
//          =========
//           =======
//            =====
//             ===
//              =
// ===========================================





  { id: 45001, label: "croissant",
  question:
  "ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³croissant",
  answer:
  "cornetto" },





];

// ã‚¯ã‚¤ã‚ºãƒ–ãƒ­ãƒƒã‚¯ä½œæˆ
const titles = ["ã‚¤ã‚¿ãƒªã‚¢èª"]; // ä»»æ„ã®ç§‘ç›®åãƒªã‚¹ãƒˆ
const template = document.querySelector('.quiz-block'); // æœ€åˆã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«
const container = document.createElement('div'); // å…¨ä½“ã‚’åŒ…ã‚€è¦ç´ ï¼ˆä»»æ„ï¼‰

titles.forEach((title, index) => {
  const newBlock = template.cloneNode(true);
  newBlock.id = `quizBlock-${index}`;

  // ã‚¿ã‚¤ãƒˆãƒ«æ›¸ãæ›ãˆ
  newBlock.querySelector('p.title').textContent = title;

  // IDä»˜ãè¦ç´ ã®IDã‚’ã™ã¹ã¦æ›´æ–°
  const elementsWithId = newBlock.querySelectorAll('[id]');
  elementsWithId.forEach(el => {
    const oldId = el.id;
    const newId = oldId.replace(/-\d+$/, `-${index}`);
    el.id = newId;
  });

  container.appendChild(newBlock);
});

// å…ƒã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å‰Šé™¤ã—ã¦ãŠãï¼ˆé‡è¤‡ã‚’é˜²ãï¼‰
template.remove();
document.body.appendChild(container); // ã‚ã‚‹ã„ã¯é©åˆ‡ãªå ´æ‰€ã¸è¿½åŠ 



// ã‚¯ã‚¤ã‚ºä½œæˆ
function createQuiz(blockId, data) {
    const questionArea = document.getElementById(`questionArea-${blockId}`);
    const answerArea = document.getElementById(`answerArea-${blockId}`);
    const nextBtn = document.getElementById(`nextBtn-${blockId}`);
    const showAnswerBtn = document.getElementById(`showAnswerBtn-${blockId}`);
    const correctBtn = document.getElementById(`correctBtn-${blockId}`);
    const wrongBtn = document.getElementById(`wrongBtn-${blockId}`);
    const statusTable = document.getElementById(`statusTable-${blockId}`);
    const startSelect = document.getElementById(`startSelect-${blockId}`);
    const endSelect = document.getElementById(`endSelect-${blockId}`);
    const excludeCorrectSelect = document.getElementById(`excludeCorrectSelect-${blockId}`);
    const sortSelect = document.getElementById(`sortSelect-${blockId}`);
    const resetCountsBtn = document.getElementById(`resetCountsBtn-${blockId}`);


    let currentId = null;
    let remaining = [];
    let previousHighlightedId = null; // å‰å›é’ãã—ãŸã‚»ãƒ«ã®IDã‚’ä¿å­˜
    let lastBlueId = null; // ç›´å‰ã«é’ã«ã—ãŸã‚»ãƒ«



    const statusMap = new Map();
    const wrongCounts = new Map();
    const correctCounts = new Map();

    // çŠ¶æ…‹åˆæœŸåŒ–
    function init() {
        startSelect.innerHTML = '';
        endSelect.innerHTML = '';
        excludeCorrectSelect.innerHTML = '';
        lastBlueId = null;

        data.forEach(d => {
            const opt1 = document.createElement("option");
            opt1.value = d.id;
            opt1.textContent = d.id;
            const opt2 = opt1.cloneNode(true);
            startSelect.appendChild(opt1);
            endSelect.appendChild(opt2);
        });
        startSelect.value = data[0].id;
        endSelect.value = data[data.length - 1].id;

        for (let i = 1; i <= 5; i++) {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = i;
            excludeCorrectSelect.appendChild(opt);
        }
        excludeCorrectSelect.value = 5;


        for (const [value, label] of [
        ['label-asc', 'labelæ˜‡é †'],
        ['label-desc', 'labelé™é †'],
        ['id-asc', 'idæ˜‡é †'],
        ['id-desc', 'idé™é †']
        ]) {
            const opt = document.createElement("option");
            opt.value = value;
            opt.textContent = label;
            sortSelect.appendChild(opt);
        }
        sortSelect.value = 'label-asc';

        startSelect.value = localStorage.getItem(`startSelect-${blockId}`) ?? data[0].id;
        endSelect.value = localStorage.getItem(`endSelect-${blockId}`) ?? data[data.length - 1].id;
        excludeCorrectSelect.value = localStorage.getItem(`excludeCorrectSelect-${blockId}`) ?? 5;
        sortSelect.value = localStorage.getItem(`sortSelect-${blockId}`) ?? 'label-asc';


        buildTable();
        loadWrongCounts();
        loadCorrectCounts();
        resetState();
        loadCellColors(); // â† æœ€å¾Œã«è¿½åŠ 
    }
  
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    function buildTable() {
        statusTable.innerHTML = '';
        statusMap.clear();
        const sortedData = getSortedData();
        const rowHeight = 500 / data.length + 'px';

        sortedData.forEach(d => {
            const row = statusTable.insertRow();
            const cell = row.insertCell();
            cell.textContent = d.label;
            row.style.height = rowHeight;
            cell.style.position = "relative";

            const wrongCount = wrongCounts.get(d.id) ?? 0;
            const correctCount = correctCounts.get(d.id) ?? 0;

            // weightè¨ˆç®— (ä¸æ­£è§£+1)/(æ­£è§£+1)
            const weight = ((wrongCount + 1) / (correctCount + 1)).toFixed(2);

            // weightè¡¨ç¤º
            const weightSpan = document.createElement("span");
            weightSpan.className = "weight-display";
            weightSpan.textContent = weight;
            cell.appendChild(weightSpan);

            const wrongSpan = document.createElement("span");
            wrongSpan.className = "wrong-count";
            wrongSpan.textContent = `Ã—${wrongCount}`;
            cell.appendChild(wrongSpan);

            const correctSpan = document.createElement("span");
            correctSpan.className = "correct-count";
            correctSpan.textContent = `â—‹${correctCount}`;
            cell.appendChild(correctSpan);

            statusMap.set(d.id, { cell, wrongSpan, correctSpan, weightSpan });
        });

        loadCellColors();
    }



    // å•é¡Œæ–‡ãƒ»ç­”ãˆãƒªã‚»ãƒƒãƒˆ
    function resetState() {
        remaining = [];
        currentId = null;
        lastBlueId = null;
        questionArea.textContent = "ã“ã“ã«å•é¡Œæ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
        answerArea.textContent = "ã“ã“ã«ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
        data.forEach(d => {
            const entry = statusMap.get(d.id);
            entry.cell.className = '';
        });
        setButtonsEnabled(false);
        buildTable();
    }


    // æ­£è§£ãƒ»ä¸æ­£è§£æ•°ã‚’ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
    resetCountsBtn.addEventListener('click', () => {
        if (!confirm('æ­£è§£ãƒ»ä¸æ­£è§£æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;

        // ã‚«ã‚¦ãƒ³ãƒˆåˆæœŸåŒ–
        wrongCounts.clear();
        correctCounts.clear();

        // localStorageã‹ã‚‰å‰Šé™¤
        localStorage.removeItem(`wrongCounts-${blockId}`);
        localStorage.removeItem(`correctCounts-${blockId}`);
        localStorage.removeItem(`cellColors-${blockId}`); // â† ã“ã®1è¡Œã‚’è¿½åŠ 


        // ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
        buildTable();
    });

    // ãƒœã‚¿ãƒ³ã‚’ä½¿ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
    function setButtonsEnabled(enabled) {
        showAnswerBtn.disabled = !enabled;
        correctBtn.disabled = !enabled;
        wrongBtn.disabled = !enabled;
    }


    // å‡ºé¡Œç¯„å›²ã®å–å¾—
    function getRangeData() {
        const start = parseInt(startSelect.value);
        const end = parseInt(endSelect.value);
        const excludeThreshold = parseInt(excludeCorrectSelect.value);
        return data.filter(d =>
            d.id >= start &&
            d.id <= end &&
            (correctCounts.get(d.id) ?? 0) < excludeThreshold
        );
    }
    // ä¸¦ã³é †ã®å–å¾—
    function getSortedData() {
        const sortType = sortSelect.value;
        const sorted = [...data];
        switch (sortType) {
            case 'label-asc':
            sorted.sort((a, b) => a.label.localeCompare(b.label));
            break;
            case 'label-desc':
            sorted.sort((a, b) => b.label.localeCompare(a.label));
            break;
            case 'id-asc':
            sorted.sort((a, b) => a.id - b.id);
            break;
            case 'id-desc':
            sorted.sort((a, b) => b.id - a.id);
            break;
        }
        return sorted;
    }
 

    // å‡ºé¡Œ
    function pickQuestion() {
        if (remaining.length === 0) {
            questionArea.textContent = "ãŠã‚ã‚Šï¼";
            answerArea.textContent = "";
            setButtonsEnabled(false);
            return;
        }

        const now = new Date();
        const weights = remaining.map(item => {
            const wrong = wrongCounts.get(item.id) ?? 0;
            const correct = correctCounts.get(item.id) ?? 0;

            let days = 0;
            if (item.lastReview) {
                days = Math.floor((now - new Date(item.lastReview)) / (1000 * 60 * 60 * 24));
            }

            return ((wrong + 1) / (correct + 1)) * (1 + days * 0.1);
        });

        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let r = Math.random() * totalWeight;
        let index = 0;
        for (let i = 0; i < weights.length; i++) {
            r -= weights[i];
            if (r <= 0) {
                index = i;
                break;
            }
        }

        const item = remaining.splice(index, 1)[0];
        currentId = item.id;
        item.lastReview = now; // å‡ºé¡Œæ™‚ã«æ›´æ–°

        let styledQuestion = item.question
          .replace(/(\(|ï¼ˆ)(.*?)(\)|ï¼‰)/g, '<span style="color: orange;">$1$2$3</span>')
          .replace(/ã€(.*?)ã€‘|{(.*?)}/g, (match, p1, p2) => {
            if (p1 !== undefined) return `<span style="color: red; font-weight: bold;">ã€${p1}ã€‘</span>`;
            if (p2 !== undefined) {
              let inner = p2.replace(/ã€(.*?)ã€‘/g, '<span style="color: red; font-weight: bold;">ã€$1ã€‘</span>');
              return `<span style="color: blue; font-weight: bold; text-decoration: underline;">{${inner}}</span>`;
            }
            return match;
          });

        questionArea.innerHTML = styledQuestion;
        answerArea.innerHTML = `<span style="color: gray;">ã“ã“ã«ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>`;
        highlightCell(item.id, 'blue');
        setButtonsEnabled(true);

        if (window.MathJax) MathJax.typesetPromise([questionArea]);
    }


    // ã‚»ãƒ«è‰²ã‚’ä»˜ã‘ã‚‹
    // function highlightCell(id, className) {
    //     const entry = statusMap.get(id);
    //     entry.cell.className = '';
    //     if (className) {
    //             entry.cell.classList.add(className);
    //             saveCellColor(id, className); // â† è¿½åŠ 
    //     } else {
    //             removeCellColor(id); // â† è¿½åŠ ï¼šè‰²ã‚’æ¶ˆã—ãŸã¨ãã«ã‚‚åæ˜ 
    //     }
    // }
    // function highlightCell(id, className) {
    //     // å‰å›é’ã ã£ãŸã‚»ãƒ«ã‚’å…ƒã®è‰²ã«æˆ»ã™
    //     if (previousHighlightedId !== null && previousHighlightedId !== id) {
    //         restoreCellClass(previousHighlightedId); // å¾©å…ƒå‡¦ç†
    //     }

    //     const entry = statusMap.get(id);
    //     entry.cell.className = '';
    //     if (className) {
    //         entry.cell.classList.add(className);
    //         if (className !== 'blue') {
    //             saveCellColor(id, className);
    //         }
    //     } else {
    //         removeCellColor(id);
    //     }

    //     // ä»Šå›é’ãã—ãŸã‚»ãƒ«ã‚’è¨˜éŒ²
    //     if (className === 'blue') {
    //         previousHighlightedId = id;
    //     } else {
    //         previousHighlightedId = null;
    //     }
    // }
    function highlightCell(id, className) {
      // æ–°ã—ã„é’ã‚’ä»˜ã‘ã‚‹ç›´å‰ã«ã€å‰å›ã®é’ã‚»ãƒ«ã‚’å…ƒã®è‰²ã«æˆ»ã™
      if (className === 'blue' && lastBlueId !== null && lastBlueId !== id) {
        restoreCellClass(lastBlueId);
      }

      const entry = statusMap.get(id);
      if (!entry) return;

      // ã„ã£ãŸã‚“å…¨æ¶ˆã—ã—ã¦ã‹ã‚‰æŒ‡å®šè‰²ã‚’é©ç”¨
      entry.cell.className = '';
      if (className) {
        entry.cell.classList.add(className);

        if (className !== 'blue') {
          // green/red ã¯ä¿å­˜ï¼ˆblue ã¯ä¿å­˜ã—ãªã„ï¼‰
          saveCellColor(id, className);
          lastBlueId = null; // é’ã®é¸æŠçŠ¶æ…‹ã¯è§£é™¤
        } else {
          // blue ã¯ä¿å­˜ã—ãªã„ãŒã€ç›´å‰ã®é’ã¨ã—ã¦è¨˜éŒ²
          lastBlueId = id;
        }
      } else {
        // è‰²ã‚’å¤–ã™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        removeCellColor(id);
        if (lastBlueId === id) lastBlueId = null;
      }
    }


    // function restoreCellClass(id) {
    //     const entry = statusMap.get(id);
    //     if (!entry) return;

    //     // localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã‚’å¾©å…ƒ
    //     const savedClass = loadCellColor(id);
    //     entry.cell.className = '';

    //     if (savedClass) {
    //         entry.cell.classList.add(savedClass);
    //     }
    // }
    function restoreCellClass(id) {
      const entry = statusMap.get(id);
      if (!entry) return;

      entry.cell.className = '';
      const savedClass = getSavedCellColor(id); // â† 1ä»¶å–å¾—ã«å¤‰æ›´
      if (savedClass) {
        entry.cell.classList.add(savedClass);
      }
    }

    // ã‚»ãƒ«è‰²ã‚’ä¿å­˜
    function saveCellColor(id, className) {
        if (className !== "blue"){
            const key = `cellColors-${blockId}`;
            const saved = localStorage.getItem(key);
            const colors = saved ? JSON.parse(saved) : {};
            colors[id] = className;
            localStorage.setItem(key, JSON.stringify(colors));
        }
    }
    // ã‚»ãƒ«è‰²ã‚’å‰Šé™¤
    function removeCellColor(id) {
        const key = `cellColors-${blockId}`;
        const saved = localStorage.getItem(key);
        if (saved) {
            const colors = JSON.parse(saved);
            delete colors[id];
            localStorage.setItem(key, JSON.stringify(colors));
        }
    }
    // ã‚»ãƒ«è‰²ã‚’ãƒ­ãƒ¼ãƒ‰
    function loadCellColors() {
        const key = `cellColors-${blockId}`;
        const saved = localStorage.getItem(key);
        if (saved) {
            const colors = JSON.parse(saved);
            for (const [idStr, className] of Object.entries(colors)) {
            const id = parseInt(idStr);
            const entry = statusMap.get(id);
            if (entry) {
                entry.cell.classList.add(className);
            }
            }
        }
    }

    function getSavedCellColor(id) {
      const key = `cellColors-${blockId}`;
      const saved = localStorage.getItem(key);
      if (!saved) return null;
      const colors = JSON.parse(saved);
      return colors[id] ?? null;
    }


    // é–“é•ã„æ•°ã‚’ä¿å­˜
    function saveWrongCounts() {
        const obj = {};
        for (const [id, count] of wrongCounts.entries()) {
            obj[id] = count;
        }
        localStorage.setItem(`wrongCounts-${blockId}`, JSON.stringify(obj));
    }
    // é–“é•ã„æ•°ã‚’ãƒ­ãƒ¼ãƒ‰
    function loadWrongCounts() {
        const saved = localStorage.getItem(`wrongCounts-${blockId}`);
        if (saved) {
            const obj = JSON.parse(saved);
            for (const [idStr, count] of Object.entries(obj)) {
                const id = parseInt(idStr);
                wrongCounts.set(id, count);

                // ã‚«ã‚¦ãƒ³ãƒˆã‚’è¡¨ç¤º
                const entry = statusMap.get(id);
                if (entry && entry.wrongSpan) {
                    entry.wrongSpan.textContent = `Ã—${count}`;
                }
            }
        }
    }
  
    // æ­£è§£æ•°ã‚’ä¿å­˜
    function saveCorrectCounts() {
        const obj = {};
        for (const [id, count] of correctCounts.entries()) {
            obj[id] = count;
        }
        localStorage.setItem(`correctCounts-${blockId}`, JSON.stringify(obj));
    }
    // æ­£è§£æ•°ã‚’ãƒ­ãƒ¼ãƒ‰
    function loadCorrectCounts() {
        const saved = localStorage.getItem(`correctCounts-${blockId}`);
        if (saved) {
            const obj = JSON.parse(saved);
            for (const [idStr, count] of Object.entries(obj)) {
                const id = parseInt(idStr);
                correctCounts.set(id, count);

                // ã‚«ã‚¦ãƒ³ãƒˆã‚’è¡¨ç¤º
                const entry = statusMap.get(id);
                if (entry && entry.correctSpan) {
                    entry.correctSpan.textContent = `â—‹${count}`;
                }
            }
        }
    }

    // å‡ºé¡Œç¯„å›²ã®å€¤ãŒå¤‰ã‚ã£ãŸã‚‰ä¿å­˜
    startSelect.addEventListener('change', () => {
        localStorage.setItem(`startSelect-${blockId}`, startSelect.value);
    });
    endSelect.addEventListener('change', () => {
        localStorage.setItem(`endSelect-${blockId}`, endSelect.value);
    });
    // æ­£è§£æ•°ã«ã‚ˆã‚‹å‡ºé¡Œç¯„å›²ãŒå¤‰ã‚ã£ãŸã‚‰ä¿å­˜
    excludeCorrectSelect.addEventListener('change', () => {
        localStorage.setItem(`excludeCorrectSelect-${blockId}`, excludeCorrectSelect.value);
    });


    // æ­£è§£æ•°ã«ã‚ˆã‚‹å‡ºé¡Œç¯„å›²ãŒå¤‰ã‚ã£ãŸã‚‰ä¿å­˜
    sortSelect.addEventListener('change', () => {
        localStorage.setItem(`sortSelect-${blockId}`, sortSelect.value);
        buildTable();
    });
    // å‡ºé¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
    nextBtn.addEventListener('click', () => {
        const rangeData = getRangeData();
        // å‡ºé¡Œã™ã‚‹å•é¡ŒãŒç„¡ããªã£ãŸã‚‰ãŠã‚ã‚Šï¼
        if (remaining.length === 0 && questionArea.textContent === "ãŠã‚ã‚Šï¼") {
            resetState();
        }
        remaining = rangeData.slice();
        pickQuestion();
    });

    function colorizeParentheses(text) {
      const colors = [
        "#FFA500", // æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸
        "#FFB733", // å°‘ã—è–„ã„
        "#FFCC80", // ã•ã‚‰ã«è–„ã„
        "#FFE0B3"  // ã‚‚ã£ã¨è–„ã„ï¼ˆå¿…è¦ãªã‚‰å¢—ã‚„ã™ï¼‰
      ];

      let result = "";
      let depth = 0;

      for (let char of text) {
        if (char === "(" || char === "ï¼ˆ") {
          const color = colors[Math.min(depth, colors.length - 1)];
          result += `<span style="color: ${color};">` + char;
          depth++;
        } else if (char === ")" || char === "ï¼‰") {
          depth = Math.max(0, depth - 1);
          result += char + "</span>";
        } else {
          result += char;
        }
      }

      return result;
    }

    // ç­”ãˆã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
    showAnswerBtn.addEventListener('click', () => {
        if (currentId !== null) {
            const item = data.find(d => d.id === currentId);
            // answerArea.innerHTML = `<span style="color: black;">${item.answer}</span>`;

          let styledAnswer = colorizeParentheses(item.answer)
            // ã€ã€‘ã¨{}ã®å‡¦ç†ã‚’é©ç”¨
            .replace(/ã€(.*?)ã€‘|{(.*?)}/g, (match, p1, p2) => {
              if (p1 !== undefined) {
                return `<span style="color: red; font-weight: bold;">ã€${p1}ã€‘</span>`;
              }
              if (p2 !== undefined) {
                let inner = p2.replace(/ã€(.*?)ã€‘/g, '<span style="color: red; font-weight: bold;">ã€$1ã€‘</span>');
                return `<span style="color: blue; font-weight: bold; text-decoration: underline;">{${inner}}</span>`;
              }
              return match;
            });

          // å…¨ä½“é»’ã§å›²ã‚€
          answerArea.innerHTML = `<span style="color: black;">${styledAnswer}</span>`;
        }
        
        // MathJaxã§æ•°å¼ã‚’å†æç”»
        if (window.MathJax) {
            MathJax.typesetPromise([answerArea]);
        }
    });
    // æ­£è§£ã—ãŸãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
    correctBtn.addEventListener('click', () => {
        if (currentId !== null) {
            const entry = statusMap.get(currentId);
            const newCount = (correctCounts.get(currentId) ?? 0) + 1;
            correctCounts.set(currentId, newCount);

            if (entry && entry.correctSpan) {
            entry.correctSpan.textContent = `â—‹${newCount}`;
            }

            highlightCell(currentId, 'green');
            saveCorrectCounts();
            pickQuestion();
        }
    });
    // ä¸æ­£è§£ã ã£ãŸãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
    wrongBtn.addEventListener('click', () => {
        if (currentId !== null) {
            const entry = statusMap.get(currentId);
            const newCount = (wrongCounts.get(currentId) ?? 0) + 1;
            wrongCounts.set(currentId, newCount);

            if (entry && entry.wrongSpan) {
            entry.wrongSpan.textContent = `Ã—${newCount}`;
            }

            highlightCell(currentId, 'red');
            saveWrongCounts();
            pickQuestion();
        }
    });

    init();
}

createQuiz(0, quizData0);
// createQuiz(1, quizData2);
// createQuiz(2, quizData3);
// createQuiz(3, quizData4);

// localstrageã®å†…å®¹ã‚’è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
document.getElementById('showStorageBtn').addEventListener('click', function() {
    let totalSize = 0;
    let output = 'ğŸ“¦ LocalStorage ã®å†…å®¹:\n\n';

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        const size = new Blob([key + value]).size;
        totalSize += size;

        output += `ğŸ”‘ ${key} = ${value} (${size} bytes)\n`;
    }

    output += `\nğŸ’¾ åˆè¨ˆä½¿ç”¨é‡: ${totalSize} bytes (${(totalSize / 1024).toFixed(2)} KB)`;

    document.getElementById('storageInfo').textContent = output;
});
document.getElementById('clearStorageBtn').addEventListener('click', function() {
    document.getElementById('storageInfo').textContent = ''; // è¡¨ç¤ºå†…å®¹ã‚’ã‚¯ãƒªã‚¢
});

document.querySelectorAll('.floating-buttons button').forEach(button => {
  button.addEventListener('click', () => {
    const targetId = button.getAttribute('data-target');
    const targetElement = document.getElementById(targetId);
    if (targetElement) {
      targetElement.scrollIntoView({ behavior: 'smooth' });
    }
  });
});

</script>
</body>
</html>
